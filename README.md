# ComfyUI-AlignLayout

节点对齐、节点拉伸、快捷菜单、收藏菜单、自动布局、选择相同、替换节点、快速连接


# 📐 对齐面板 (Align Panel)

**快捷键**: `Alt + A` (默认，可在设置中修改)

对齐面板专为解决 ComfyUI 节点排列杂乱的问题而设计。通过直观的径向菜单和底部控制栏，你可以快速将选中的多个节点对齐到同一基准线、均匀分布，甚至一键自动重新布局整个工作流。

## ✨ 核心亮点

### 双模操作体验 (效率极高)

- **点击触发**：像传统菜单一样，移动鼠标点击按钮即可执行操作。
  
  ![alt text](docs/modules/../../images/点击触发.gif)
- **甩动触发 (Mouse Flick)**：按下快捷键后**不松开鼠标**，快速向圆环上按钮的方向“甩”动一段距离，即可瞬间触发功能并关闭面板。这是肌肉记忆形成后的最高效操作方式！
  
  ![alt text](docs/modules/../../images/甩动触发.gif)

### 智能交互设计

- **位置自适应**：面板永远在当前鼠标位置弹出，操作路径极短。
- **动态指示器**: 面板中心的三角形会实时跟随你的鼠标，指示即将触发的方向。
- **自动退出**：完成操作、点击空白处或取消节点选中时，面板自动关闭，不干扰视线。

## 🎮 功能布局 (默认配置)

面板分为两个主要区域：**环形菜单** 和 **底部控制栏**。
*注意：所有按钮的功能都可以在设置中完全自定义。以下介绍基于默认配置。*

### 1. 环形菜单 (Ring Menu)

环形菜单包含 8 个方向，涵盖了最常用的对齐与分布功能。

![alt text](docs/modules/../../images/对齐面板.png)

### 基础对齐 (十字方向)

- **⬆️ 上 (Top Align)**: 顶对齐。将所有节点顶部边缘对齐到最高节点的上边界。
- **⬇️ 下 (Bottom Align)**: 底对齐。将所有节点底部边缘对齐到最低节点的下边界。
- **⬅️ 左 (Left Align)**: 左对齐。将所有节点左侧边缘对齐到最左节点的左边界。
- **➡️ 右 (Right Align)**: 右对齐。将所有节点右侧边缘对齐到最右节点的右边界。

### 居中与分布 (斜角方向)

- **↖️ 左上 (Horizontal Center)**: 水平居中。对齐所有节点的水平中心线。
- **↗️ 右上 (Vertical Center)**: 垂直居中。对齐所有节点的垂直中心线。
- **↙️ 左下 (Distribute V)**: 垂直平均分布。在最上和最下节点之间，将中间节点按**等间距**垂直排列。
- **↘️ 右下 (Distribute H)**: 水平平均分布。在最左和最右节点之间，将中间节点按**等间距**水平排列。

### 2. 底部控制栏 (Bottom Bar)

底部包含 3 个强大的高级功能按钮，左右两侧按钮支持数值输入。

- **Left (左侧胶囊)**: **📏 垂直指定间距 (Stack Vertically)**
    - 将选中节点在垂直方向上紧凑排列。
    - **数值输入**: 在胶囊左侧输入数字（如 `50`），表示节点之间的固定像素间距。
    - *适用场景：整理一列参数节点，使其紧凑且间距一致。*
- **Center (中间圆形)**: **✨ 自动布局 (Auto Layout)**
    - 基于节点连接关系，自动重新排列选中的节点（如未选中则排列全图）。
    - *适用场景：一键拯救杂乱无章的“意大利面条”连线。*
- **Right (右侧胶囊)**: **📏 水平指定间距 (Stack Horizontally)**
    - 将选中节点在水平方向上紧凑排列。
    - **数值输入**: 在胶囊左侧输入数字，控制节点间距。
    - *适用场景：整理一行流程节点。*

## ⚙️ 设置与自定义 (Settings)

本插件具有极高的可配置性。在 ComfyUI 的设置菜单中找到 **NodeAligner** 分类。

### 1. 按钮功能自定义 (Button Remapping)

你可以重新定义面板上 **11 个按钮**（环形8个 + 底部3个）的具体功能。
可选功能包括：

- 上/下/左/右对齐
- 垂直/水平居中
- 垂直/水平平均分布 (Distribute)
- 垂直/水平指定间距 (Stack，支持输入数值)
- 自动布局 (Auto Layout)

### 2. 自动布局设置 (Auto Layout)

- **Layout Direction**: 选择布局流向（从左到右 / 从右到左）。
- **Horizontal/Vertical Spacing**: 调整自动布局时的节点间距。

### 3. 手势与外观

- **Menu Radius**: 调整环形菜单的大小。
- **Flick Distance/Speed**: 调整“甩动触发”的灵敏度，防止误触。
- **Shortcut**: 修改呼出面板的快捷键。



# 📏 拉伸面板 (Stretch Panel)

**快捷键**: `Alt + S` (默认，可在设置中修改)

拉伸面板用于统一节点的大小尺寸。它不仅能让节点看起来整齐划一，还能一键修复节点尺寸异常（如过大或过小）的问题。

## ✨ 交互技巧

### 双模操作体验

- **点击触发**：像传统菜单一样，移动鼠标点击按钮即可执行操作。
- **甩动触发 (Mouse Flick)**：按下快捷键后不松开鼠标，快速向目标方向“甩”动，即可瞬间触发功能并关闭面板。这是肌肉记忆形成后的最高效操作方式！


### 智能交互设计

- **位置自适应**：面板永远在当前鼠标位置弹出，操作路径极短。
- **动态指示器**: 面板中心的三角形会实时跟随你的鼠标，指示即将触发的方向。
- **互斥模式**: 打开拉伸面板会自动关闭对齐面板，反之亦然。
- **自动退出**：完成操作、点击空白处或取消节点选中时，面板自动关闭，不干扰视线。

## 🎮 核心功能 (默认配置)

环形菜单包含 8 个方向，涵盖了最常用的尺寸调整功能。
*注意：所有按钮的功能都可以在设置中完全自定义。以下介绍基于默认配置。*

![alt text](docs/modules/../../images/拉伸面板.png)

### 1. 单侧拉伸 (Edge Stretch)

位于圆环的上、下、左、右四个正方向。这种拉伸方式**固定对侧边缘不动**，只改变指定的一侧。

- **⬆️ 顶部拉伸 (Stretch Top)**: 将选中节点的**顶部**拉伸至与最高节点对齐（底部位置不变，节点变高）。
- **⬇️ 底部拉伸 (Stretch Bottom)**: 将选中节点的**底部**拉伸至与最低节点对齐（顶部位置不变，节点变高）。
- **⬅️ 左侧拉伸 (Stretch Left)**: 将选中节点的**左侧**拉伸至与最左节点对齐（右侧位置不变，节点变宽）。
- **➡️ 右侧拉伸 (Stretch Right)**: 将选中节点的**右侧**拉伸至与最右节点对齐（左侧位置不变，节点变宽）。

### 2. 全尺寸匹配 (Max Match)

位于圆环的左上角和右上角。

- **↖️ 水平最大宽度 (Stretch H-Max)**: 获取选中节点中**最宽**的那个节点的宽度，并将所有其他节点的宽度设置为该值（保持各自的中心点位置不变）。
- **↗️ 垂直最大高度 (Stretch V-Max)**: 获取选中节点中**最高**的那个节点的高度，并将所有其他节点的高度设置为该值（保持各自的中心点位置不变）。

### 3. 尺寸重置 (Size Reset)

位于圆环的左下角和右下角，用于快速恢复节点到标准状态。

- **↙️ 最小尺寸 (Min Size)**: 将节点缩小到能容纳其内部内容（标题、输入输出槽、控件）的**物理极限最小尺寸**。
    - *适用场景*：当节点因为手动拖拽变得过大且留白太多时。
- **↘️ 默认尺寸 (Default Size)**: 强制将节点的宽度重置为 ComfyUI 的标准宽度 (**320px**)，高度则根据内容自动适应。
    - *适用场景*：当你想让乱七八糟的节点瞬间恢复到刚创建时的整齐模样。

## ⚙️ 设置与自定义 (Settings)

本插件支持高度自定义。在 ComfyUI 的设置菜单中找到 **NodeResizer** 分类。

### 1. 按钮功能自定义 (Button Remapping)

你可以重新定义环形菜单上 **8 个方向按钮**（上/下/左/右/左上/右上/左下/右下）的具体功能。
可选功能包括：

- 顶部/底部/左侧/右侧拉伸
- 水平/垂直两侧拉伸 (Max Match)
- 默认尺寸 / 最小尺寸

### 2. 手势与外观

- **Menu Radius**: 调整环形菜单的大小（半径）。
- **Flick Distance/Speed**: 调整“甩动触发”的灵敏度（触发距离和速度阈值），防止误触。
- **Shortcut**: 修改呼出面板的快捷键。



# Auto Layout

**Auto Layout** 是一个轻量级但功能强大的 ComfyUI 扩展插件，旨在通过智能算法一键自动整理和排列您的工作流节点，让乱糟糟的画布瞬间变得井井有条。

![alt text](docs/modules/../../images/自动布局.gif)

## ✨ 主要功能 (Features)

- **智能流式布局 (Smart Flow Layout)**
    - **独立流分组**：自动识别互不相关的节点组（连通分量），将它们分开计算和排列，互不干扰。
    - **逆向推导模式（默认/推荐）**：以输出节点（如 `Save Image`）为终点，从右向左反向推导。同一列节点**向右对齐**，确保连线端口整齐划一。
    - **正向模式**：传统的从左向右排列。同一列节点**向左对齐**。
- **局部与全局整理 (Selection Aware)**
    - **局部整理**：选中一组节点，按下快捷键，仅自动排列选中的节点，不影响画布其他部分。
    - **全局整理**：点击画布空白处（取消所有选择），按下快捷键，自动整理整个工作流。
- **智能对齐与防重叠**
    - **端口感知排序**：同一列的节点会根据它们连接到下一列节点的**输入端口顺序**进行上下排列（例如：连接到 `Model` 端口的节点会排在连接到 `VAE` 端口的节点上方）。
    - **智能顶对齐**：单输出节点会自动与其目标节点进行顶部对齐，视觉更整洁。
    - **防碰撞机制**：自动计算节点尺寸，防止节点重叠。
- **高度可配置 (Fully Configurable)**
    - 支持自定义**水平间距**和**垂直间距**。
    - 支持自定义**快捷键**（默认为 `Alt+L`，支持组合键如 `Ctrl+Shift+K`）。
    - 原生集成到 ComfyUI 设置面板，支持多语言（中文/英文）。

## 🚀 使用方法 (Usage)

### 快捷键

默认快捷键为 **`Alt + L`**。

### 操作演示

1. **整理选中的节点**：
    - 使用鼠标框选一部分乱序的节点。
    - 按下 `Alt + L`。
    - 节点将在当前位置附近自动吸附并排列整齐。
2. **整理所有节点**：
    - 点击画布空白处确保没有节点被选中。
    - 按下 `Alt + L`。
    - 所有节点将以画布右侧（逆向模式）或左侧（正向模式）为基准重新排列。

> 提示：该操作支持撤销！如果不满意自动排列的结果，请按下 Ctrl + Z 即可恢复原状。
> 

## ⚙️ 设置说明 (Configuration)

点击 ComfyUI 菜单栏的 **设置 (Settings)** 图标（齿轮），在左侧侧边栏找到 **"AlignLayout"** 选项卡。

### Auto Layout (自动布局)

- **Layout Direction (布局方向)**
    - **Right-to-Left (逆向 - 推荐)**：从右向左排列，适合大部分生图工作流。同一列节点向右对齐。
    - **Left-to-Right (正向)**：从左向右排列。同一列节点向左对齐。
- **Horizontal Spacing (水平间距)**
    - 控制列与列之间的像素距离。默认为 `80`。
- **Vertical Spacing (垂直间距)**
    - 控制同一列中节点之间的垂直像素距离。默认为 `60`。
- **Shortcut (快捷键)**
    - 自定义触发自动布局的组合键。
    - 格式示例：`Alt+L`、`Ctrl+Shift+K`。默认为 `Alt+L`。

## 🤝 贡献 (Contributing)

欢迎提交 Issues 和 Pull Requests 来改进布局算法或添加新功能！

## 📄 许可证 (License)

MIT License



# ComfyUI Add Node Menu (添加节点菜单)

这是一个为 ComfyUI 设计的高效节点添加工具。它提供了一个跟随鼠标的级联菜单，支持快捷键唤出、智能记忆位置、拖拽置顶和节点收藏功能，旨在极大地提升工作流搭建速度。

![alt text](docs/modules/../../images/添加节点菜单.gif)

## ✨ 核心特性

- **快捷键唤出**：按下 `A` 键，菜单即刻在鼠标位置出现。
- **智能定位**：
    - 首次打开：菜单自动居中于鼠标。
    - 再次打开：自动记忆上次使用的分类，并将该分类对准鼠标，形成肌肉记忆。
- **拖拽置顶 (Pin)**：支持通过拖拽将常用节点或分组固定在菜单顶部。
- **节点收藏 (Favorite)**：标记常用节点，以醒目的绿色标识显示。
- **本地存储**：所有配置保存在用户目录下，方便迁移备份。
- **现代化 UI**：深色磨砂玻璃风格，流畅的动画效果。

## 📦 安装方法

1. 进入 ComfyUI 的 `custom_nodes` 目录。
2. 将本插件文件夹复制进去（或使用 `git clone`）。
3. 重启 ComfyUI。

## 📖 使用指南

### 1. 基础操作

- **唤出菜单**：在画布空白处（不要聚焦在输入框内），按下键盘上的 **`A`** 键。
- **添加节点**：点击菜单项即可将节点添加到**唤出菜单时鼠标所在的坐标**。
- **关闭菜单**：点击屏幕任意空白处，或按下 `Esc` 键。

### 2. 置顶功能 (Pinning)

置顶功能允许你将常用的节点或全部分组固定在当前列表的最上方。

- **添加置顶**：
    - **方法一（右键）**：在任意节点或分组上 **右键点击**，选择 `⭐ 置顶 (Pin)`。
    - **方法二（拖拽）**：按住节点或分组，将其拖拽到菜单列表的 **最上方**（或分隔线以上区域）。
    - **添加第一个置顶**：如果当前没有置顶项，直接将节点拖拽到菜单容器的**顶部边缘**，顶部会亮起蓝色光条，松开即可添加。
- **调整顺序**：在置顶区域内，可以通过拖拽上下移动来调整排列顺序。
- **取消置顶**：
    - **右键点击**置顶项，选择 `⭐ 取消置顶 (Unpin)`。
    - 或者将置顶项**拖拽**到下方的普通列表区域（显示红色背景），松开即可移除。

> 视觉提示：置顶项的背景色会比普通项稍深。
> 

### 3. 收藏功能 (Favorites)

收藏功能用于高亮标记你喜欢的节点，方便在长列表中快速识别。

- **操作**：在节点或分组上 **右键点击**，选择 `❤️ 收藏 (Favorite)`。
- **视觉效果**：已收藏的节点左侧会出现一条 **鲜艳的绿色竖线**。

### 4. 菜单分类逻辑

一级菜单分为三个区域（由上至下）：

1. **系统常用/置顶区**：包含被你置顶的分组，以及系统默认的常用分组（如 Utils, Sampling, Image 等）。
2. **普通分组区**：按字母顺序排列的其他节点分组。
3. **其他 (Others)**：未分类的节点。

## 💾 数据存储与迁移

本插件的所有用户配置（置顶、收藏、最后位置）均保存在 ComfyUI 的用户数据目录中，**不会因为清除浏览器缓存而丢失**。

- **数据路径**：
`ComfyUI/user/AlignLayout/`
- **文件说明**：
    - `pins.json`: 记录置顶信息。
    - `quick.json`: 记录收藏信息。
    - `last_category.json`: 记录最后一次打开的分类位置。

**如何迁移？**
如果你更换电脑或重装 ComfyUI，只需备份并复制 `ComfyUI/user/AlignLayout/` 文件夹到新环境即可保留所有习惯设置。

## 常见问题 (Q&A)

**Q: 按下 A 键没有反应？**
A: 请确保：

1. 你的鼠标焦点不在提示词输入框或搜索框内。
2. 并没有按住 Ctrl、Shift 或 Alt 等组合键。
3. 检查浏览器控制台 (F12) 是否有报错。

**Q: 收藏了某个分组，为什么里面的节点没有变绿？**
A: 收藏是独立的。收藏分组只会标记该分组本身（方便在一级菜单看到），不会级联标记其内部的所有子节点。

**Q: 置顶是全局的吗？**
A: 不完全是。置顶是“层级内”的。

- 在主菜单置顶“图像”分组，它会在主菜单置顶。
- 在“图像”分组内置顶“Load Image”节点，它只会在“图像”分组内置顶。



# ComfyUI Quick Node Menu (快捷节点菜单)

这是一个为 ComfyUI 设计的**高频节点极速访问工具**。它与 "Add Node Menu" 完美配合，专门用于展示你**收藏 (Favorite)** 的节点和分组，通过精简的列表让你专注于核心工作流。

![alt text](docs/modules/../../images/收藏节点菜单.gif)

## ✨ 核心特性

- **极速唤出**：按下 **`Q`** 键，仅包含你最爱节点的菜单即刻出现。
- **数据联动**：自动读取并同步你在 Add Node Menu (按 `A` 键) 中“收藏”的内容。
- **独立置顶**：拥有独立的置顶 (Pin) 逻辑。你可以在这里将“收藏中的最爱”再次置顶，与主菜单互不干扰。
- **快速管理**：支持直接在菜单中右键移除不再需要的收藏项。
- **视觉区分**：采用紫色系高亮风格，与主菜单的蓝色风格区分，防止混淆。

## 📦 安装方法

本插件通常作为 Add Node Menu 套件的一部分安装。
确保你的 `custom_nodes` 目录下包含本插件的文件夹，并重启 ComfyUI。

## 📖 使用指南

### 1. 如何填充内容？

Quick Menu 默认是空的。你需要先通过 Add Node Menu 添加内容：

1. 按下 **`A`** 键打开主菜单。
2. 在任意节点或分组上 **右键点击**。
3. 选择 **`❤️ 收藏 (Favorite)`**。
4. 现在，按下 **`Q`** 键，该项就会出现在 Quick Menu 中了。

### 2. 基础操作

- **唤出菜单**：在画布空白处，按下键盘上的 **`Q`** 键。
- **添加节点**：点击菜单项即可将节点添加到鼠标当前位置。
- **移除收藏**：
    - 在 Quick Menu 的根目录下，**右键点击**任意项。
    - 选择 **`移除 (Remove)`**。
    - 该项将从收藏列表中删除（同时也会在 Add Node Menu 中取消收藏标记）。

### 3. 独立置顶 (Pinning)

Quick Menu 的置顶是**完全独立**的。你可以在这里通过置顶来调整收藏项的排序，而不会影响 Add Node Menu 的排序。

- **操作方式**：
    - **右键**：点击项，选择 `置顶 (Pin)`。
    - **拖拽**：按住项，将其拖拽到菜单列表的**最上方**。
- **调整顺序**：在置顶区域内，拖拽上下移动即可调整顺序。

### 4. 互斥显示

为了保持界面整洁，当你按下 `Q` 键时，如果屏幕上已打开了 `A` 键菜单，它会自动关闭，反之亦然。屏幕上永远只会存在一个菜单。

## 💾 数据存储

Quick Menu 与 Add Node Menu 共享收藏数据，但拥有独立的配置文件：

- **数据路径**：`ComfyUI/user/AlignLayout/`
- **文件说明**：
    - `add_node_menu_quick.json` (🔴 **核心共享文件**)：存储所有被“收藏”的节点和分组数据。Quick Menu 读取此文件显示内容。
    - `quick_menu_pins.json` (🔵 **独立文件**)：仅记录 Quick Menu 内部的置顶排序。
    - `quick_menu_last_category.json` (🔵 **独立文件**)：记录 Quick Menu 上次打开的位置。

## 常见问题 (Q&A)

**Q: 按下 Q 键提示 "Quick Menu is empty"？**
A: 请先按 `A` 打开主菜单，右键点击你常用的节点选择“收藏”，然后再按 `Q`。

**Q: 我在 Quick Menu 里置顶了节点，按 A 键的主菜单里也会置顶吗？**
A: **不会**。两者的置顶系统是分开的。这允许你在主菜单保留一套通用的置顶逻辑，而在 Quick Menu 建立一套针对特定任务的置顶逻辑。

**Q: 如果我删除了 Add Node Menu 插件，这个还能用吗？**
A: Quick Menu 依赖 `add_node_menu_quick.json` 数据文件。虽然理论上代码分离了，但设计逻辑上它们是伴生关系，建议同时保留。



# ComfyUI Fast Link 插件使用手册

**ComfyUI Fast Link** 是一个旨在提升节点连接效率的纯前端插件。它通过智能的空间排序算法和快捷键逻辑，帮助用户实现极速的多对一、一对多、链式连接以及端口切换等操作。

![alt text](docs/modules/../../images/快速连接.gif)

## 🎹 快捷键速查表

> 注意：以下快捷键中的 F 为默认设置，你可以在 ComfyUI 设置面板中自定义为主键（例如改 为 J 或 K）。
> 

| 快捷键 | 模式名称 | 单次按下行为 | 多次连续按下行为 (轮询) |
| --- | --- | --- | --- |
| **`F`** | **多对一 (汇聚)** | 将左侧/上方所有节点的输出，连接到最右侧/下方节点的输入。 | **切换终点接口**：在目标节点的不同输入端口间轮询切换。 |
| **`Shift + F`** | **一对多 (广播)** | 将最左侧/上方节点的输出，连接到其余所有节点的输入。 | **切换起点接口**：在源节点的不同输出端口间轮询切换。 |
| **`Ctrl + F`** | **强制多对一** | **强制**将左侧所有节点连接到终点（会断开旧连接）。 | **切换源节点**：在左侧的源节点列表中依次切换，每次只连接一个源到终点。 |
| **`Ctrl + Shift + F`** | **强制一对多** | **强制**将起点节点连接到右侧所有节点（会断开旧连接）。 | **切换目标节点**：在右侧的目标节点列表中依次切换，每次只连接起点到一个目标。 |
| **`Alt + F`** | **链式连接** | 按照视觉顺序依次连接节点 (1→2→3→4)。 | *(重新执行连接计算)* |
| **`Ctrl + Shift + Alt + F`** | **清除内部连线** | **仅断开**当前选中节点之间**内部**互相连接的线，不影响连接到外部的线。 | - |

## ⚙️ 设置选项说明

你可以在 ComfyUI 的设置面板中找到 **"AlignLayout > FastLink"** 分类，进行以下配置：

1. **启用 Fast Link 插件 (Enable Fast Link)**
    - 全局开关，一键禁用插件功能。
2. **全局快捷键 (Shortcut Key)**
    - 默认为 `F`。你可以将其修改为任何单字母按键（不区分大小写）。修改后，上述所有组合键将基于新按键生效。
3. **垂直堆叠判定阈值 (Vertical Stack Threshold)**
    - **默认值 0.8**。
    - 控制“多对一”和“链式连接”时的排序逻辑。只有当两个节点的**水平重叠部分**超过较小节点宽度的 **80%** 时，插件才会认为它们是“垂直排列”的（按上下排序）；否则视为“水平排列”（按左右排序）。
    - *调小此值（如 0.5）会让错位摆放的节点更容易被判定为垂直列。*
4. **模式重置超时 (Mode Reset Timeout)**
    - **默认值 2000ms**。
    - 当你连续按键进行“接口切换”或“节点轮播”时，如果停止操作超过这个时间，计数器会重置。下次再按将重新开始，而不是继续切换。
5. **端口匹配优先级 (Port Match Priority)**
    - **名称 + 类型 (严格)**：默认值。优先连接名称和类型都相同的端口（3分），其次连接仅类型相同的端口（2分）。
    - **仅类型 (宽松)**：忽略端口名称，只要类型匹配（如 IMAGE 连 IMAGE）就视为最高优先级。适合不规范命名的节点。

## 🛠️ 详细功能逻辑

### 1. 智能保护与切换

- **非强制模式 (`F`, `Shift+F`)**：
    - 第一次按下时，**绝对不会**断开目标端口已有的连线，只会填补空位。
    - **轮询切换时**：当你连续按下快捷键（触发切换逻辑），插件会自动清理掉**上一次轮询产生的那条连线**，以便连接到新的接口。这保证了画面的整洁，同时不会误伤其他不想动的连线。
- **强制模式 (`Ctrl+...`)**：
    - 总是优先尝试断开目标端口的旧连线，确保当前的源节点能连上。

### 2. 清除内部连线 (`Ctrl+Shift+Alt+F`)

- 这是一个非常实用的清理工具。
- **场景**：你选中了节点 A, B, C。其中 A 连着 B，B 连着 C，C 连着外部的节点 D。
- **操作**：按下此快捷键。
- **结果**：A->B 和 B->C 的线断开。C->D 的线**保留**（因为 D 不在选区内）。

## 🧠 核心算法机制

### A. 视觉列排序 (Visual Column Sort)

- **应用场景**：`F`, `Ctrl+F`, `Alt+F`
- **原理**：利用“垂直堆叠判定阈值”来智能识别你的布局是“横向流”还是“纵向栈”。完美解决了错位布局（半重叠）时的连接顺序混乱问题。

### B. 严格左上排序 (Strict Left Sort)

- **应用场景**：`Shift + F`, `Ctrl+Shift+F`
- **原理**：严格寻找坐标最左（其次最上）的节点作为发射源，符合“广播”操作的直觉。



# 替换节点 (Replace Node)

**替换节点** 是一个强大的工作流编辑工具，它允许你以“热替换”的方式，将旧节点替换为任意新节点，同时**自动保留并迁移原有的输入、输出连线以及参数值**。

![alt text](docs/modules/../../images/替换节点.gif)

该功能采用独特的“交互模式”设计，并支持自动呼出搜索面板，极大地提升了编辑效率。

## 🎮 操作流程

### 第一步：进入替换模式

1. 选中画布上一个或多个需要被替换的节点（批量替换时，选中的节点必须是相同类型的）。
2. 将鼠标悬停在画布的任意空白位置（推荐）。
3. 按下默认快捷键 **`Shift + R`**。

### 第二步：选择新节点

进入模式后，插件会立即执行以下动作：

1. **视觉反馈**：被选中的旧节点将显示**金色高亮边框**和**呼吸光晕**，表示已进入“待替换状态”。
2. **自动呼出菜单**：默认情况下，**“节点搜索框”会自动在你的鼠标位置弹出**。
*(你不再需要手动双击画布空白处，直接输入关键词即可)*

> 补充方式：如果你不小心关闭了自动弹出的搜索框，保持在“替换模式”下（高亮未消失），你依然可以使用任意方式添加新节点（如右键菜单、拖拽、从剪贴板粘贴），它们都会触发替换逻辑。
> 

### 第三步：自动替换

一旦你从搜索框中选中了新节点：

1. 插件会自动删除刚才高亮的旧节点。
2. 在**旧节点的位置**生成新的节点实例。
3. **智能重连**：自动迁移旧节点的连线和 Widget 值到新节点。
4. 自动退出替换模式，并选中所有新节点。

> 提示：如果在替换模式下不想替换了，再次按下 Shift + R 或点击空白处即可退出模式，高亮消失。
> 

## 🧠 智能迁移逻辑

当旧节点被替换为新节点时，插件会按照以下优先策略迁移数据：

1. **完全匹配**：端口名称 (Name) 和 数据类型 (Type) 完全一致。
2. **名称匹配**：端口名称一致（类型可能不同）。
3. **类型唯一匹配**：如果旧节点有一个 `IMAGE` 类型的端口，而新节点也**只有唯一一个** `IMAGE` 类型的端口，会自动连接。
4. **强制顺序连接 (兜底策略)**：
    - 如果开启了 **Force Connection**（默认开启），当上述匹配都失败时，插件会尝试按照端口的顺序（第1个连第1个，第2个连第2个...）进行连接。
    - 这意味着即使类型不匹配（如将 `INT` 连到 `FLOAT`），连线也会被保留。这对于快速替换结构相似但定义不同的节点非常有用。
    - 如果关闭此选项，类型不匹配的连线将被断开。

### 特殊支持

- **动态数组节点**：对于像 `PixNodes` 这类支持 `image_1`, `image_2` 动态扩展的节点，插件会自动添加缺失的端口以容纳所有连线。
- **JSON 合并节点**：对于 `JsonObjectCombine` 这类根据输入文本生成端口的节点，插件会自动分析旧连线并配置新节点。

## ⚙️ 设置与自定义

你可以在 ComfyUI 设置面板的 `AlignLayout` -> `Replace Node` 分类中深度定制该功能：

### 基础与行为

- **Enable Replace Node**
    - 说明：开启/关闭功能。
    - 默认值：`True`
- **Auto Open Menu (新功能)**
    - 说明：进入替换模式后自动打开的菜单类型。
    - 选项：
        - `Search Box (Default)`: 自动打开节点搜索框（跟随鼠标位置）。
        - `Add Node Menu`: 自动打开分类菜单。
        - `Quick Node Menu`: 自动打开收藏夹菜单。
        - `None`: 不自动打开任何菜单，仅高亮节点。
- **Force Connection**
    - 说明：是否开启强制顺序连接。建议开启，可最大化保留连线。
    - 默认值：`True`
- **Shortcut**
    - 说明：自定义快捷键。
    - 默认值：`Shift+R`

### 视觉样式 (Visual Style)

你可以自定义“替换模式”下的高亮外观，使其符合你的主题偏好：

- **Highlight Color**: 高亮的主题色（支持 Hex 格式，如 `#FF0000` 红色，`#00FFFF` 青色）。
- **Fill Opacity**: 高亮填充的透明度（0.0 - 1.0）。
- **Glow Strength**: 边缘发光/模糊的强度。
- **Stroke Width**: 高亮边框的线条粗细。

*注：本功能支持撤销（Undo）。如果替换结果不符合预期，按下 `Ctrl+Z` 即可完全恢复到替换前的状态。*



# 选择相同节点 (Select Same Nodes)

**选择相同节点** 是一个高效的辅助功能，允许用户一键选中画布上所有与当前选中节点类型一致的节点。这在整理大型工作流、批量修改参数或批量移动同类节点时非常有用。

![alt text](docs/modules/../../images/选择相同节点.gif)

## 🎮 操作方法

1. **选中模板节点**
在画布上点击选中一个（或多个）你想要查找的节点。
    
    > 例如：你选中了一个 Load Image 节点。
    > 
2. **触发快捷键**
按下默认快捷键 **`Shift + A`**。
3. **结果**
画布上所有类型为 `Load Image` 的节点都会被立即加入到当前的选中状态中。

## ⚙️ 设置说明

你可以在 ComfyUI 的设置面板中找到 `AlignLayout` -> `Select Same` 分类进行自定义：

- **Enable Select Same Nodes**
    - 说明：功能总开关，关闭后快捷键将失效。
    - 默认值：`True`
- **Shortcut**
    - 说明：自定义触发快捷键。支持组合键，如 `Ctrl+Alt+S`。
    - 默认值：`Shift+A`

## 💡 使用技巧

- **多类型选择**：如果你同时选中了一个 `KSampler` 和一个 `VAE Decode`，按下快捷键后，画布上所有的 `KSampler` 和所有的 `VAE Decode` 都会被选中。
- **配合排版**：选中所有同类节点后，配合 ComfyUI 的自动排版插件或对齐工具，可以快速整理混乱的连线。


# 联系我们

如有问题请提交 Issue。